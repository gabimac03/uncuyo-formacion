<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Restablecer contraseña</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body class="login-body">
  <div class="card">
    <h1>Restablecer contraseña</h1>
    <form id="fReset">
      <label>Nueva contraseña (mínimo 8 caracteres)
        <input type="password" id="p1" minlength="8" required />
      </label>
      <label>Repetir nueva contraseña
        <input type="password" id="p2" minlength="8" required />
      </label>
      <button class="btn" type="submit">Actualizar contraseña</button>
      <p class="msg" id="msg"></p>
    </form>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    function getToken() {
      const u = new URL(location.href);
      return u.searchParams.get('token') || '';
    }

    $('#fReset')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      $('#msg').textContent = '';

      const token = getToken();
      if (!token) {
        $('#msg').textContent = 'Token faltante.';
        return;
      }
      const p1 = $('#p1').value;
      const p2 = $('#p2').value;
      if (p1.length < 8) { $('#msg').textContent = 'La contraseña debe tener al menos 8 caracteres.'; return; }
      if (p1 !== p2)     { $('#msg').textContent = 'Las contraseñas no coinciden.'; return; }

      try {
        const r = await fetch('/api/password/reset', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ token, newPassword: p1 })
        });
        const data = await r.json().catch(()=>({}));
        if (!r.ok || !data.ok) {
          $('#msg').textContent = data.error || 'No se pudo actualizar.';
          return;
        }
        $('#msg').style.color = '#22c55e';
        $('#msg').textContent = 'Contraseña actualizada. Redirigiendo al login...';
        setTimeout(() => location.href = '/login.html', 1200);
      } catch {
        $('#msg').textContent = 'Error de red.';
      }
    });
  </script>
</body>
</html>
